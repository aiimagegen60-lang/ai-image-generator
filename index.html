<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Image Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#0b0b0b;
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
}

/* ===== HEADER ===== */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 14px;
  background:#161616;
}
.header-right{
  display:flex;
  align-items:center;
  gap:14px;
  font-size:14px;
}
.badge{
  background:#222;
  padding:6px 10px;
  border-radius:18px;
}

/* ===== MAIN ===== */
.container{
  padding:14px;
  max-width:520px;
  margin:auto;
}

textarea{
  width:100%;
  height:90px;
  border:none;
  border-radius:14px;
  padding:12px;
  font-size:16px;
  outline:none;
}

button{
  width:100%;
  margin-top:12px;
  padding:14px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:bold;
  background:#00e676;
  color:#000;
  cursor:pointer;
}
button.locked{
  background:#555;
  color:#aaa;
}

.watch-ads{
  margin-top:10px;
  text-align:center;
  color:#00e676;
  cursor:pointer;
  font-size:14px;
}

/* ===== GRID ===== */
.grid{
  margin-top:16px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.card{
  position:relative;
  border-radius:14px;
  overflow:hidden;
  background:#111;
}
.card img{
  width:100%;
  display:block;
}

/* ===== ICON OVERLAY ===== */
.icon-wrap{
  position:absolute;
  top:6px;
  right:6px;
  display:flex;
  gap:6px;
}
.icon-btn{
  width:26px;
  height:26px;
  border-radius:8px;
  background:rgba(0,0,0,0.65);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.icon-btn svg{
  width:14px;
  height:14px;
  fill:#fff;
}

/* ===== PREVIEW POPUP ===== */
#preview{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99;
}
.popup{
  background:#161616;
  padding:14px;
  border-radius:16px;
  width:90%;
  max-width:360px;
}
.popup img{
  width:100%;
  border-radius:12px;
}
.prompt-box{
  background:#0f0f0f;
  border-radius:10px;
  padding:10px;
  margin-top:10px;
  position:relative;
}
.copy-btn{
  position:absolute;
  top:6px;
  right:6px;
  font-size:12px;
  background:#222;
  color:#00e676;
  padding:4px 6px;
  border-radius:6px;
  cursor:pointer;
}
.hidden{display:none;}
</style>
</head>

<body>

<!-- ===== HEADER ===== -->
<header>
  <div>ü§ñ AI Image Generator</div>
  <div class="header-right">
    <div class="badge">Coins: <span id="coins">---</span></div>
    <div>üìÅ Gallery</div>
    <div>‚¨á Install</div>
  </div>
</header>

<!-- ===== MAIN ===== -->
<div class="container">

  <textarea id="prompt" placeholder="Describe your image..."></textarea>

  <button id="generateBtn" onclick="generate()">‚ö° Generate Image</button>

  <div class="watch-ads" onclick="openAdPopup()">üëÅÔ∏è Watch ads ‚Üí get coins</div>

  <div class="grid" id="grid"></div>

</div>

<!-- ===== PREVIEW POPUP ===== -->
<div id="preview">
  <div class="popup">
    <img id="previewImg">
    <div class="prompt-box">
      <div id="previewPrompt"></div>
      <div class="copy-btn" onclick="copyPrompt()">COPY</div>
    </div>
    <button style="margin-top:10px" onclick="closePreview()">Close</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://fragrant-salad-e7eb.aiimagegen60.workers.dev";

/* ================= SESSION ================= */
const session =
  localStorage.getItem("session") ||
  (() => {
    const s = crypto.randomUUID();
    localStorage.setItem("session", s);
    return s;
  })();

/* ================= STATE ================= */
const coinsEl = document.getElementById("coins");
const grid = document.getElementById("grid");
const generateBtn = document.getElementById("generateBtn");

let images = [];

/* ================= INIT ================= */
fetch(API_URL + "/init",:fetch(API_URL + "/gallery", {
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({ session })
})
.then(r=>r.json())
.then(d=>{
  images = d.images || [];
  renderGrid();
});
 {
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({ session })
})
.then(r=>r.json())
.then(d=>{
  coinsEl.innerText = d.coins;
  toggleGenerate(d.coins);
});

/* ================= GENERATE ================= */
function generate(){
  fetch(API_URL + "/generate", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      session,
      prompt: document.getElementById("prompt").value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.error){
      alert("Coins finished. Watch ad.");
      return;
    }

    coinsEl.innerText = d.coins;
    toggleGenerate(d.coins);

    d.images.forEach(url=>{
      images.unshift({
        url,
        prompt: document.getElementById("prompt").value
      });
    });

    renderGrid();
  });
}

/* ================= GRID ================= */
function renderGrid(){
  grid.innerHTML="";
  images.forEach((img,i)=>{
    grid.innerHTML += `
      <div class="card">
        <img src="${img.url}" onclick="openPreview(${i})">
        <div class="icon-wrap">
          <div class="icon-btn" onclick="download('${img.url}')">
            <svg viewBox="0 0 24 24">
              <path d="M5 20h14v-2H5v2zm7-18v10.17l3.59-3.58L17 10l-5 5-5-5 1.41-1.41L11 12.17V2h1z"/>
            </svg>
          </div>
          <div class="icon-btn" onclick="removeImage(${i})">
            <svg viewBox="0 0 24 24">
              <path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zm3.46-7.12l1.41-1.41L12 11.59l1.12-1.12 1.41 1.41L13.41 13l1.12 1.12-1.41 1.41L12 14.41l-1.12 1.12-1.41-1.41L10.59 13l-1.13-1.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
          </div>
        </div>
      </div>`;
  });
}

/* ================= PREVIEW ================= */
function openPreview(i){
  preview.style.display="flex";
  previewImg.src = images[i].url;
  previewPrompt.innerText = images[i].prompt;
}
function closePreview(){
  preview.style.display="none";
}
function copyPrompt(){
  navigator.clipboard.writeText(previewPrompt.innerText);
  alert("Prompt copied");
}

/* ================= HELPERS ================= */
function download(url){
  const a=document.createElement("a");
  a.href=url;a.download="image.jpg";a.click();
}
function removeImage(i){
  images.splice(i,1);
  renderGrid();
}
function toggleGenerate(c){
  if(c < 2){
    generateBtn.disabled = true;
    generateBtn.classList.add("locked");
  }else{
    generateBtn.disabled = false;
    generateBtn.classList.remove("locked");
  }
}

/* ================= ADS (backend trigger later) ================= */
function openAdPopup(){
  alert("Watching ad... wait 15 sec");
  setTimeout(()=>{
    fetch(API_URL + "/watch-ad", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ session })
    })
    .then(r=>r.json())
    .then(d=>{
      coinsEl.innerText = d.coins;
      toggleGenerate(d.coins);
      alert("Coins added!");
    });
  },15000);
}

</body>
</html>
